---
title: "Getting started with models"
format:
  revealjs:
    theme: solarized
    resources: ["img/"]
editor: visual
---

# Conceptual Model Brainstorming

-   Some Results

## How to start - what is my model {.scrollable}

-   Clearly define your goal

-   Draw your conceptual model

-   What are your:

-   [Inputs]{style="color: lightblue;"}

-   [Outputs]{style="color: lightblue;"}

-   What’s in the box (the model itself) that gives you a relationship between outputs and inputs, type of model: [Transfer function]{style="color: blue;"}

-   [Parameters]{style="color: lightblue;"} Values that influences how the model relationships work

# Types of Models (what kind do you need?)

Conceptual.............Mathematical

Stochastic.............Deterministic

Lumped.............Spatially Distributed: *SPACE*

Static.............Dynamic : *TIME*

Abstract/ML.............Physically/Process Based

# Goal

Estimate the power generated from a reservoir ...

# Example: Conceptual model

![](img/reservoir_cm.jpeg)

# Example: Input/Output/Parameters

-   **Input**: Reservoir height and flow rate

-   **Output**: Instantaneous power generation (W/s)

-   **Parameters**: K Efficiency , ρ (density of water), g (acceleration due to gravity)

## Mathematical model (Transfer Function) {.scrollable}

P = ρ \* h \* r \* g \* K Efficiency;

-   P is Power in watts,
-   ρ is the density of water (\~1000 kg/m3)
-   h is height in meters,
-   r is flow rate in cubic meters per second,
-   g is acceleration due to gravity of 9.8 m/s2,
-   K Efficiency is a coefficient of efficiency ranging from 0 to 1.

Type of model?

## What type of model is this? {.scrollable}

# Answer:

This is a

-   **static** (one point in time),
-   **deterministic**
-   **spatially lumped** (one place)
-   its more or less **physically based**

How would we expand it to make it

-   dynamic?
-   spatially distributed?
-   stochastic?

# Related Types of models: Example

If we expand the model to output power production over a year, where inputs were streamflow for each day into the reservoir - *Dynamic Model*

If we expand to model power production from all the reservoirs in California, accounting for spatial patterns of snowmelt inputs and upstream-downstream relationships - *Spatially Distributed Model*

If we modified the model to estimate the probability distribution of power production, given a probability distribution of reservoir levels - *Stochastic Model*

## STEPS: Modeling for Problem Solving in ES {.scrollable}

Clearly define your goal (a question you want to answer, hypothesis you want to test, prediction you want to make) - as precisely as possible

-   Sketch conceptual model

-   **Design or Select your model**

-   Implement the model

-   Evaluate the model and quantify uncertainty

-   Apply the model to the goal

-   Communicate model results

## Off-the-Shelf Models

-   Developed and tested by experts
-   Reduces need to build from scratch

![Reinventing the wheel](img/two_prehistoric_women_reinventing_wheel.jpg)

## Model Selection

-   Is model structure **appropriate**?
-   Is model performance **good enough**?
-   Choose the **simplest** model that captures your processes of interest

------------------------------------------------------------------------

## Model Selection: Is it Appropriate

Does it fit your conceptual model

-   Can it use the inputs you have or can get?
-   Are outputs of interest captured?
-   Is resolution appropriate?
    -   space
    -   time
-   Does it include key mechanisms?

Can you use it to answer your question - can you change inputs/parameters that reflect scenarios you care about

------------------------------------------------------------------------

## Model Selection: Appropriate

Lets consider an example questions

**Example Q1**: Will a forest fire in the upper 1/2 of a watershed impact streamflow more than a similarly sized fire lower (nearer the stream) in the watershed?

Why might you need a physically based model rather than a statistical model?

What are some key processes that need to be represented?

With a partner, spend 5 minutes brainstorming on conceptual model - and what you would need to answer this question

## Some initial ideas

Two components of the conceptual model -

-   why does fire impact streamflow (Tree-ET)

-   why does location of fire matter

    -   difference in water use?
    -   lateral downslope transport of released water to stream

## RHESSys

Includes tree-impact on evapotranspiration and links between upslope and downslope water availability

![RHESSys](img/rhessys_processes.png)

## Model Selection: Representation

Example Q2: As trees age does "hardening" of the arteries - e.g reduced rates of water flow in the xylem, impact their water use (evapotranspiration)?

![Within Plant Hydro Model](img/vascular.png)

[*Citation: McElrone, A. J., Choat, B., Gambetta, G. A. & Brodersen, C. R. (2013) Water Uptake and Transport in Vascular Plants. Nature Education Knowledge 4(5):6*]{style="font-size:50%"}

## Model Selection: Performance

The other 1/2 of model selection is.....

Will it estimate the outputs accurately enough?

**Quiz**

Add an example of how you might evaluate a model to decide if the performance is good enough

Pick an example

-   from your experience with working with models OR
-   from something you read OR
-   make something up that makes sense to you

## Is it Good Enough?

-   Error small relative to:

    -   Model application (why do you need the estimate)
    -   Simulated effect size

-   Demonstrated improvement (its the best 'we've got') for the question that we are asking

-   Based on well established theory

    -   Literature/state of the art

## Model Selection

-   is model structure appropriate (fits your conceptual model)
-   is performance good enough to answer your question

## Building your own model

Why?

-   can't find an off the shelf model that fits your conceptual model

-   can't find an off the shelf model that works with the data you have

-   can't find an off the shelf model that performs well enough

-   you want to learn how models work

-   you want to be able to experiment with model structure

## Steps: Design and Implement your model {.scrollable}

-   Conceptual Diagram your model

-   **Design** or Select your model

-   Translate diagram into a mathematical representation

-   Choose programming language

-   Define inputs (data type, units)

-   Define output (data type, units)

-   Define model structure

-   Write model

-   Document the model (meta data)

-   Test model

## Building Models {.scrollable}

Modularity! (Functions)

The basic building blocks of models

Functions are the “boxes” of the model

-   the transfer function that takes inputs and returns outputs
-   most languages have a function library (e.g. R, Python, C++)

More complex models

-   made up of multiple functions;
-   boxes with arrows
-   *main* function that calls other functions, flow control
-   nested functions (functions that other functions and control the flow

# For each box/function

Decide on

-   Inputs and parameters

-   Outputs

Data types, units (time and space aggregation), names should be (use descriptive names)

**IMPORTANT**

Place each function in its own file (x.R), and put all functions for a given project in *R* subdirectory

## Solar Photovoltaic Model {.scrollable}

**Design** - function that estimates solar pv power given inputs of radiation

**Model inputs**: solar radiation (daily direct and diffuse)

**Model outputs**: power generated each year and average power over time

**Parameters**: panel efficiency, system performance, units, type of array (uses diffuse or not), plot Y/N

Some of these options such as whether to plot determine outputs from the function

AND the type of array to determine whether it uses diffuse radiation, these parameters change how the function/model works (slightly more complex than homework)

## Solar function  {.scrollable}

The energy produced by a solar panel system is given by

$$
E = \sum{A \cdot eff_{adjusted} \cdot solar \cdot PR}
$$

where:

-   $E$ is the energy produced (kJ/yr),
-   $A$ is the solar panel area (m$^2$),
-   $eff_{adjusted}$ submodel - depends on energy
-   $PR$ is the performance ratio (dimensionless, 0–1), accounting for site-specific losses (typically $\sim 0.75$),
-   $solar$ is daily solar radiation (kJm$^{-2}/year$).


$$
\mathrm{eff}_{\text{adjusted}} =
\begin{cases}
\mathrm{eff}, & \text{if } \mathrm{solar} > e_{\text{thresh}} \\[6pt]
\mathrm{eff}\, * \max\!\left(0,\dfrac{\mathrm{solar}}{e_{\text{thresh}}}\right),
& \text{if } \mathrm{solar} \le e_{\text{thresh}}
\end{cases}
$$

- $ethresh$ Threshold solar radiation below which energy produced declines

Other parameters that impact model transfer function 

 *  $etype$ what type of radiation can be used, *direct*, or *both*

Models can also have formating options 

  * type of output desired
  * units
  * graphs/data structures/data types

## I/O {.scrollable}

*Inputs*

 -  $solar$ - data frame with columns $Kdown_{direct}$, and optionally $Kdown_{diffuse}$ ((kJ m$^{-2}/day$))
-   $A$ is the solar panel area (m$^2$),
-   $eff$ efficiency when radiation is above threshold (default 0.8)
-   $ethresh$ threshold radiation below which efficiency declines linearly (10000 (kWh m$^{-2}$))
-   $eunits$ desired units for output default "J" Joules, option "W" for Watts
-   $PR$ is the performance ratio (dimensionless, 0–1), accounting for site-specific losses (typically $\sim 0.75$)

*Formatting inputs*

-  $g$ TRUE/FALSE - True if you want to graph
-  $clr$ color of line on graph

*Outputs*

-  annual energy produced (kJ/yr or kWhr/year),
-  optional graphs of energy produced by year

## Solar function example as code  {.scrollable}

Model Code

You need *tidyverse*, *here* libraries to run.

```{r solar, echo=FALSE}
library(tidyverse)
library(here)

source(here("R/solarpv.R"))
solarpv

# Read in some data
# read in R formatted data
load(here("Data/sierraczosolar.rda"))

```

## Some Data {.scrollable}

We will plot to check that the input data makes sense

-   look at data
-   plot radiation by month

```{r datacheck}



# already in the format required for the model
head(sierraczosolar)

```

## Plot {.scrollable}

```{r datacheck2, echo=TRUE}
# plot
# lets make months names rather than labels

sierraczosolar$month <- factor(sierraczosolar$month, levels = 1:12, labels = month.abb)

# now plot
ggplot(sierraczosolar, aes(x = month, y = (Kdown_direct+Kdown_diffuse), fill=month)) +
  geom_boxplot() +
  labs(x = "Month", y = "Solar Radiation (W/m2)") +
  theme_bw()
```

## Run the model with this data {.scrollable}

```{r, eval=TRUE, echo=TRUE}
# run the model
solarpv(area = 0.1, solar = sierraczosolar, 
        clr = "green", eunit = "W", g=FALSE)

# run and save results - but don't plot
site1 <- solarpv(area = 0.1, solar = sierraczosolar, 
            clr = "green", eunit = "W", g = FALSE)
site1$mean
site1$annual
```

# On your own

-   read through function code
-   run the model with the data
-   change parameters and re-run
-   turn graphing on

# Visual Checking

-   what issue jumps out - what might be the cause?
-   how would you fix this?

Explore for next class

## What we are learning so far {.scrollable}

How to find the "right" tool for the job

-   The importance of establishing a goal and a conceptual model - because all models are simplifications of reality

-   Identify model types - helps you to find the "right" tool for your question (we will expand on this)

-   Two parts - does it answer your question (conceptual model fit) and does it perform well enough

-   Basics of building your own model - modular, functions, inputs/outputs/parameters 
    * some parameters impact model transfer function, other I/O formatting



# Answer to visual check {.scrollable}
```{r}
# remove the first year from the dataset
sierraczosolar <- sierraczosolar %>%
  filter(year > 1944 & year < 1954)

# now run the model again
site1 <- solarpv(area = 0.1, 
          solar = sierraczosolar, clr = "green", eunit = "kW", g = TRUE)

# keep cleaned up data set for future use
save(sierraczosolar, file=here("Data/sierraczosolar_clean.rda"))

```
