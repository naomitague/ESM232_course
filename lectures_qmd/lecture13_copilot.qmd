---
title: "Exploring Dynamic Systems with AI Assistance"
format: revealjs
execute: 
  echo: TRUE
theme: solarized
resources: ["img/"]
css: ["slides.css"]
editor: visual
---

```{r setup, include=FALSE}
library(tidyverse)
library(deSolve)
library(here)
library(sensitivity)
library(ggpubr)
```

## Fixed Harvest Example {.scrollable}

```{r fixed, echo=TRUE}
source(here("R/dharvestfixed.R"))

dharvestfixed

# try it out with different initial conditions to watch how the system moves to a stable state
tm <- seq(from = 1, to = 100)
Cinitial <- 1
gps <- list(harv = 10, K = 1000, r = 0.15, mincarbon = 20)
res <- ode(Cinitial, tm, dharvestfixed, gps, method = "euler")
colnames(res) <- c("time", "carbon")
ggplot(as.data.frame(res), aes(time, carbon)) +
  geom_line() +
  labs(y = "Forest Biomass (kgC)", x = "Year", title = "Fixed Harvest of 2kg/year\n Starting conditions 30kgC")

# why this pattern
```

# Adding complexity to your model

Think about what you would need to do to make this realistic

(practice playing with simple models)

Lets imagine growth rate changes if precipitation is above or below an optimal value

Lets also slow harvest rates if forest carbon gets within a safety margin of the minimum value

# Adding time-varing inputs to ODE

Requires time varying input \* no problem \* make use of *Time* in differential equation function used by ODE

# Case study - semi-arid tropical forest n N-E Brazil

-   Tropical forest in brazil
-   Fuel wood and charcoal harvesting is widespread

I downloaded precipitation data from CHIRPS (Climate Hazards Group InfraRed Precipitation with Station data) - uses a combination of satellite, gauge and model data to estimate precipitation

But to save time - we will just upload saved data set

There are only 20 years - and we want to think about long term growth so we will repeat the data to make a longer time series

```{r, varyprecip}

  
source(here("R/dharvestvary.R"))

dharvestvary

# read precipitation data
readRDS(here("Data/CaatPcp.RDS"))  # loads object CaatPcp

nyear = length(CaatPcp$annual_ppt_mm)
nyear

 # repeat to get 100 years
precip = rep_len(CaatPcp$annual_ppt_mm,100) 

# try it out with different initial conditions to watch how the system moves to a stable state
tm <- seq(from = 1, to = 100)
Cinitial <- 1
gps <- list(harv = 10, K = 1000, r = 0.15, mincarbon = 20, precip=precip, precip_opt=400, safety_margin=0.8)


res_alt <- ode(Cinitial, tm, dharvestvary, gps, method = "euler")

colnames(res_alt) <- c("time", "carbon")
head(res_alt)
tail(res_alt)

```

## Plot the results {.scrollable}

```{r compareplot, echo=TRUE}


ggplot(as.data.frame(res_alt), aes(time, carbon)) +
  geom_line() + geom_line(data=as.data.frame(res), aes(time,carbon), col="red")
  labs(y = "Forest Biomass (kgC)", x = "Year", title = "Fixed Harvest of 2kg/year\n Starting conditions 30kgC")

# why this pattern
```

## Ways to use dynamic models {.scrollable}

*Goal: To provide insight into environmental systems, and how they respond to intervention/disturbance/change..*

-   sensitivity analysis of output
    -   output generated by solving differential equation to see system evolution in time or space
    -   output response to variation in inputs/parameters
    -   quantifying how summary measures respond to variation in inputs/parameters

Stability focus..

-   how does systems state evolution vary with inputs/parameters
-   OR where does the system end up over time

## Model versus the real world {.scrollable}

Models can help to develop understanding, theory and hypothesis about stability by showing how different assumptions (conceptual models) impact stability

The **WHY** of stability

But the real world is more complex - but we can learn by understanding simpler models

## AI - and modelling

In 2020, test CODEX scored 78% on intro to computing test, in 2023 it scored 98%

Other studies show less accuracy...depends on the problem

Should we use it? When? How? Why? Why not?

-   whose used Copilot to help me in this course?

-   benefit/costs?

## Some thoughful papers for further reading

High level perspective

-   includes some thoughts on job market preparation

-   [Communications of the ACM](%22../papers/AIinComputingEducation.pdf%22)

-   [Practical overview/perspective](%22../papers/perspectives_ai_coding.pdf%22)

-   [Recent review on potential harmful consequenses](%22../papers/review-of-harms-fromAIcodingedu.pdf%22)

## Example of using Co-pilot

-   keep yourself in the "driver's seat"

-   remember that the conceptual map (inverse inference in your head) evolve as you learn

    -   and some learning happens indirectly through practice

# Workflow for Sensitivity Analysis

implement (or identify pre-existing) dynamic model - function syntax

obtain parameter sets (from sobel or LHS) - repeat sampling approach for different parameters

build a function that will extract the information (metrics) you want from your dynamic model (output of the ode) - quick design of the metric you decide on

create a data structure to store the metrics for each parameter set - syntax for doing so

decide on initial conditions and time period over which you will run the model

create a wrapper function

```         
runs ODE

extracts metrics
```

run wrapper function for each parameter sets

send the metrics data structure back to the sensitivity analysis object (from sobel or LHS)

plot and analyze results (syntax of ggplot)

# Example Develop using Copilot

```{r stableforestoutline}
source(here("R/dharvestvary.R"))
dharvestvary
# Create a function to compute average biomass in the last 5 years and number of year where forest is below minimum carbon from a time series

# create our two samples X1 and X2 to feed to sobol
# create sobol sensitivity object
# create the a wrapper function 
# test wrapper function

# run the wrapper function for each parameter set using pmap
# plot results Average Biomass as histogram
# create sobol sensitivity object using  average biomass output
# priint first order and total order sensitivity indices for average biomass
# plot average biomass against harvest rate with growth rate as color 
```

# Example Code that works

```{r stableforest}
source(here("R/dharvestvary.R"))
dharvestvary


# Create a function to compute average biomass in the last 5 years and number of year where forest is below minimum carbon from a time series
compute_metrics <- function(time, biomass, mincarbon) {
  last_5_years <- tail(biomass, 5)
  avg_biomass <- mean(last_5_years)
  years_below_min <- sum(biomass < mincarbon)
  return(c(avg_biomass = avg_biomass, years_below_min = years_below_min))
}

# test using our results from above
  metrics <- compute_metrics(res[, "time"], res[, "carbon"], gps$mincarbon)
  print(metrics)


# create our two samples X1 and X2 to feed to sobol
set.seed(123)
n <- 1000
X1 <- data.frame(
  harv = runif(n, 0, 200),
  K = runif(n, 4000, 5000),
  r = runif(n, 0.10, 0.30),
  mincarbon = runif(n, 100, 200),
  precip_opt = runif(n, 200, 225),
  
  safety_margin = runif(n, 0, 1)
)

X2 <- data.frame(
    harv = runif(n, 0, 200),
  K = runif(n, 4000, 5000),
  r = runif(n, 0.0, 0.30),
  mincarbon = runif(n, 100, 200),
  precip_opt = runif(n, 200, 225),
  
  safety_margin = runif(n, 0, 1)
)

# create sobol sensitivity object
sens_harvest <- sobolSalt(model = NULL, X1, X2, nboot = 300)

colnames(sens_harvest$X) <- c("harv", "K", "r", "mincarbon", "precip_opt", "safety_margin")

 precip = runif(n=length(tm), min=50, max=500)

# create the a wrapper function 
wrapper_function <- function(parms, precip) {
  tm <- seq(from = 1, to = 100)
  Cinitial <- 30
  parms = as.list(parms)
  names(parms) = c("harv", "K", "r", "mincarbon", "precip_opt", "safety_margin")
  parms$precip <- precip
  
  res <- ode(Cinitial, tm, dharvestvary, parms, method = "euler")
  colnames(res) <- c("time", "carbon")
  metrics <- compute_metrics(res[, "time"], res[, "carbon"], parms$mincarbon)
  return(metrics)
}

# test wrapper function
wrapper_function(as.list(sens_harvest$X[1, ]), precip)

# run the wrapper function for each parameter set using pmap
library(purrr)
results <- pmap(as.data.frame(sens_harvest$X), ~ wrapper_function(c(...), precip))
results_df <- as.data.frame(do.call(rbind, results))
colnames(results_df) <- c("avg_biomass", "years_below_min")

# plot results
# Average Biomass
ggplot(as.data.frame(results_df), aes(x = avg_biomass)) +
  geom_histogram(bins = 30, fill = "blue", color = "black") +
  labs(title = "Distribution of Average Biomass",
       x = "Average Biomass (kgC)",
       y = "Frequency")

# Years Below Minimum Carbon
ggplot(as.data.frame(results_df), aes(x = years_below_min)) +
  geom_histogram(bins = 30, fill = "red", color = "black") +
  labs(title = "Distribution of Years Below Minimum Carbon",
       x = "Years Below Minimum Carbon",
       y = "Frequency")

# create data frame with parameters and output metrics
harv_results = cbind.data.frame(sens_harvest$X, results_df)


# compute sobol sensitivity for average biomass
sens_harvest_avgbiomass = tell(sens_harvest, results_df$avg_biomass)
# print first order and total order sensitivity indices for average biomass
rownames(sens_harvest_avgbiomass$S) = colnames(sens_harvest$X)
sens_harvest_avgbiomass$S
rownames(sens_harvest_avgbiomass$T) = colnames(sens_harvest$X)
sens_harvest_avgbiomass$T

# plot average biomass against harvest rate with growth rate as color
ggplot(harv_results, aes(x = harv, y = avg_biomass, color = r)) +
  geom_point() +
  labs(title = "Average Biomass vs Harvest Rate",
       x = "Harvest Rate (kgC/year)",
       y = "Average Biomass (kgC)",
       color = "Growth Rate (r)") +
  theme_minimal()

# plot average biomass against growth rate with harvest as color
ggplot(harv_results, aes(x = r, y = avg_biomass, color = harv)) +
  geom_point() +
  labs(title = "Average Biomass vs Growth Rate",
       x = "Growth Rate (r)",
       y = "Average Biomass (kgC)",
       color = "Harvest Rate (kgC/year)") +
  theme_minimal()


# compute sobobl sensitivity for years below minimum carbon
sens_harvest_yearsbelowmin = tell(sens_harvest, results_df$years_below_min)
# print first order and total order sensitivity indices for years below minimum carbon
rownames(sens_harvest_yearsbelowmin$S) = colnames(sens_harvest$X)
sens_harvest_yearsbelowmin$S
rownames(sens_harvest_yearsbelowmin$T) = colnames(sens_harvest$X)
sens_harvest_yearsbelowmin$T


```

## Stability {.scrollable}

Stability analysis investigates how the system state changes, particularly focusing on where the system state 'ends up' over time and what happens when there are small perturbations to the system state

Other examples?

How would you define it?

## A broader measure of stability {.scrollable}

-   persistence

-   cycling doesn't necessarily mean unstable in an ecological sense

-   define stability based on whether or not structure or function stays within expected ranges after a "press" or "pulse" disturbance

-   can define metrics, similar to what we did for estimating performance or sensitivity

-   multiple metrics can be useful

## Examples? {.scrollable}

Ecological systems?

Human systems?

EJ?

## Stability analysis for simple differential equations {.scrollable}

A mathematical approach..

We can look at how the derivative (rate of change) \* under different system states to get a picture of when our system will be stable \* (e.g where small perturbations just bring the system back to a relatively constant state)

One way we can do this WITHOUT solving the differential equation is to look at the derivatives at different values (system states)

-   When the derivative is 0 the system is stable

-   Positive derivatives are growth

-   Negative are decline

We can use derivatives to see whether and when stability will happen

## Harvest as an example {.scrollable}

graph the derivative (how the forest carbon is changing) for different forest carbons (stock/state)

Notice where derivatives are

-   0

-   positive (growing)

-   negative (declining)

Recall these are all for a proportional harvest rate of 4% per year and a growth rate of 0.05, etc

```{r simpleapp}
tm <- seq(from = 1, to = 100)
gps <- list(harv = 0.04, K = 1000, r = 0.05)

# create a vector of current values of carbon
Ccurr <- data.frame(Ccurr = seq(from = 1, to = 300, by = 5))
Ccurr$derv <- unlist(Ccurr$Ccurr %>% map(~ dharvest(parms = gps, Time = NULL, biomass = .x)))
```

## Plot the derivative for difference "starting points" (forest carbon

)

```{r simpleapp2}
ggplot(Ccurr, aes(Ccurr, derv)) +
  geom_point() +
  geom_hline(yintercept = 0, col = "red") +
  labs(y = "Derivative\n (Rate of change of forest carbon) \n(kg/C/year)", x = "Current Forest Carbon Stock (kgC)")
```

## what do you learn from this? {.scrollable}

-   Is there a way to get a stable forest, given our harvest rate and growth rate?

-   what size of forest would you need to *start* from

-   try it

```{r try3}
# rerun our model with new initial condition that we take from the plot
tm <- seq(from = 1, to = 100)
gps <- list(harv = 0.04, K = 1000, r = 0.05)

Cinitial <- 300
res <- ode(Cinitial, tm, dharvest, gps)
colnames(res) <- c("time", "carbon")

# look at the results
ggplot(as.data.frame(res), aes(time, carbon)) +
  geom_point() +
  labs(y = "Forest Biomass (kgC)", x = "Year", title = "Proportional Harvest of 4%year\n Starting conditions 300kgC")
```

## Using derivatives to algerbraically find stability {.scrollable}

We can more formally find stability by finding the system state when the derivative is zero

$$  \frac{\partial C}{\partial t} = r*biomass*(1-\frac{biomass}{K})-harv*biomass$$

$$  0 = r*biomass*(1-\frac{biomass}{K})-harv*biomass $$

$$   biomass = K*\frac{r-h}{r} $$

$$ biomass = 1000 * (0.05-0.04)/0.05 = 200 $$

try it

## Parameter and Initial Conditions Interactions {.scrollable}

Stability also reflects other parameters -such as harvest rate

we can also experiment with how stable harvest might change with harvest rate

try repeating above with lower and higher harvest rates

```{r stability2}
source(here("R/dharvest.R"))
dharvest

# given some forest characteristics - lets look at derivatives under different harvest rates
lowHrate <- 0.015
gps <- list(harv = lowHrate, K = 100, r = 0.05)

# look at the derivative over a range of forest sizes

findstable <- data.frame(Ccurr = seq(from = 1, to = 100, by = 5))
# notice use of Time=NULL, and map to compute derivative
# for different values of forest biomass
findstable$dervHlow <- unlist(findstable$Ccurr %>% map(~ dharvest(parms = gps, Time = NULL, biomass = .x)))

ggplot(findstable, aes(Ccurr, dervHlow)) +
  geom_point() +
  geom_hline(yintercept = 0, col = "red") +
  labs(y = "Derivative\n (Rate of change of forest carbon) (kg/C/year)", x = "Current Forest Carbon Stock (kgC)")

# look at a different harvest rate
midHrate <- 0.02
gps <- list(harv = midHrate, K = 100, r = 0.05)
findstable$dervHmid <- unlist(findstable$Ccurr %>% map(~ dharvest(parms = gps, Time = NULL, biomass = .x)))

# try high rate
highHrate <- 0.05
gps <- list(harv = highHrate, K = 100, r = 0.05)
findstable$dervHhigh <- unlist(findstable$Ccurr %>% map(~ dharvest(parms = gps, Time = NULL, biomass = .x)))


# plot them all together
tmp <- gather(findstable, key = "HarvestRate", value = "value", -Ccurr)
ggplot(tmp, aes(Ccurr, value, color = HarvestRate)) +
  geom_point() +
  geom_hline(yintercept = 0, col = "black") +
  labs(x = "Forest Biomass (kgC)", y = "Forest Growth Rate (kgC/year)")

# notice how with higher harvest rates the stable population will be lower
```

## Stability in changing systems - just looking at dervatives {.scrollable}

Knowing the stability can help you understand the dynamics of the system

If we start with a Forest Carbon of 50 and low harvest rate what will happen

If we start with a Forest Carbon of 50 and a high harvest rate what will happen

Try it to find out if you are right

```{r  check}
tm <- seq(from = 1, to = 500)
gps <- list(harv = lowHrate, K = 100, r = 0.05)
Pinitial <- 50
res <- ode(Pinitial, tm, dharvest, gps)
colnames(res) <- c("time", "carbon")
ggplot(as.data.frame(res), aes(time, carbon)) +
  geom_point() +
  labs(y = "Forest Biomass (kgC)", x = "Year", title = "low harvest rate")




gps <- list(harv = highHrate, K = 100, r = 0.05)
Pinitial <- 50
res <- ode(Pinitial, tm, dharvest, gps)
colnames(res) <- c("time", "carbon")
ggplot(as.data.frame(res), aes(time, carbon)) +
  geom_point() +
  labs(y = "Forest Biomass (kgC)", x = "Year", title = "High Harvest Rate")
```

## For next class

-   Burke et al., 2021

-   Graup et al., 2022

-   Pick on of the papers to focus on in more detail, for this paper do the following:

-   In 2-3 sentences, describe how parameter uncertainty was used in the paper

-   Ask one question - something you'd like to know that wasn't covered or wasn't clear in the paper

-   If you had the same model set up available to you, what additional scenario could you run? why?

-   Upload to Canvas before class - and we will finalize in class

## Extra Credit Assignment {.scrollable}

1.  Add a harvesting to your forest growth model from the previous assignment You can be as simple or complex as you want (e.g you could repeat what I did above by making harvesting proportional to biomass)

2.  Perform some sensitivity analysis to assess how harvesting parameters interact with forest growth parameters to influence forest carbon at the end of the simulation time period (you can choose how long this is)

3.  Write 2-3 sentences to comment on what you might learn from your sensitivity analysis
