---
title: "Informal Sensitivity Analysis"
format:
  revealjs:
    theme: solarized
    resources: ["img/"]
    css: lecture.css
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

library(purrr)

library(ggpubr)

library(here)
```



## What we are learning so far {.scrollable}

How to find the "right" tool for the job

-   The importance of establishing a goal and a conceptual model - because all models are simplifications of reality

-   Identify model types - helps you to find the "right" tool for your question (we will expand on this)

-   Two parts - does it answer your question (conceptual model fit) and does it perform well enough

-   Basics of building your own model - modular, functions, inputs/outputs/parameters

    -   some parameters impact model transfer function, other I/O formatting

# Answer to visual check 

# My code to find issue and clean data {.scrollable}

```{r}

library(tidyverse)
library(here)

source(here("R/solarpv.R"))


# Read in some data
# read in R formatted data
load(here("Data/sierraczosolar.rda"))

# run model and plot
solarpv(area = 0.1, solar = sierraczosolar, 
        clr = "green", eunit = "kWhr", g=TRUE)

# notice very low power in the first year
# check input data
head(sierraczosolar)

# remove the first parital year from the dataset
sierraczosolar <- sierraczosolar %>%
  filter(year > 1944 & year < 1954)

# now run the model again
site1 <- solarpv(area = 0.1, 
          solar = sierraczosolar, clr = "green", eunit = "kW", g = TRUE)

# keep cleaned up data set for future use
save(sierraczosolar, file=here("Data/sierraczosolar_clean.rda"))

```

## Solar PV Model Review {.scrollable}

Any questions about the function

```{r solar, echo=TRUE}

source(here("R/solarpv.R"))


# read in R formatted data
load(here("Data/sierraczosolar_clean.rda"))


# run the model to check that everything works
site1 <- solarpv(area = 0.1, solar = sierraczosolar)
```

## Playing with models {.scrollable}

::: {.concept-box}
We often build models to try different options

**Model inputs**: solar radiation (daily direct and diffuse)

**Model outputs**: power generated each year and average power over time

**Parameters**: panel efficiency, system performance, units, type of array (uses diffuse or not), plot Y/N
:::

How would a lower efficiency impact mean power generated?

*eff* â€“ 0.6 instead of default 0.8  

try it

## Code - Try a different parameter set {.scrollable}

```{r, echo=TRUE}
# consider a different PV array has a non standard efficiency (0.6)
site2 <- solarpv(area = 0.1, 
        solar = sierraczosolar, g = FALSE, eff = 0.6)
site2$mean

# Compare with previous site
site1$mean
site2$mean

# relative difference
(site2$mean-site1$mean)/site1$mean * 100

# relative difference in parameter
(0.6-0.8)/0.8 * 100
```


## Informal Sensitivity Analysis {.scrollable}

What happens when we vary parameters?
  * Not always obvious when transfer function is non-linear or multi-part

**Informal** - just try varying parameters

-   decide which parameter(s) and what range to vary the parameter over - what is the uncertainty? (+- 15% )?

-   figure out how to efficiently run your model over parameter variation and save results as you go

-   analyze the sensitivity of the output to variation (simply plotting for now)

## Helpful tools {.scrollable}

-   Sampling

    -   *runif*,
    -   *rnorm* (sampling from uniform and normal distributions)
    -   *seq* (for creating a sequence of numbers)

-   Repeating

    -   in R - *purrr* package, also *apply* family of function
    -   classic *for* loops

If you need it a good source to review working with *purrr* to extract items from list and repeat operations

[Useful Purrr Resource](https://www.rebeccabarter.com/blog/2019-08-19_purrr/)

# Example

-   we will start by using **map**
-   which "maps\* a function (runs it ) for a list of values,
-   we can also use these function to extract values from a list

# R code for informal sensitivity

We are not sure what the efficiency of the PV array is

How important is this parameter to the results?

How we do this depends on what we know about efficiency

-   manufacturer reports mean and standard deviation
-   manufacturer provides a range

Mean 0.6 standard deviation of 0.1

## R code {.scrollable}

Lets do this together

```{r sen1, eval=T, echo=TRUE}
library(tidyverse)

# first come up with varying values for efficiency 
# if we don't know efficiency exactly , lets try 20 samples


eff <- rnorm(mean = 0.6, sd = 0.1, n = 20)

# use map from purrr to run model for all values of eff
# notice how map adds the one parameter that is missing from the input list

site2 <- eff %>% map(~ solarpv(area = 0.1, 
  solar = sierraczosolar, clr = "green", 
  eunit = "kWhr", g = FALSE, etype = "direct", eff = .x))

head(site2)
```

## Data Structures {.scrollable}

-   challenge in sensitivity analysis is often what data structure to use to store the results

-   organize parameter variation and result variation

-   R often returns lists - but not so easy for organization

-   ask yourself what you want to do with the data, then put in a structure that will make this easy
  -  a data frame is often the best structure for graphing

-   e.g two different data frames

    -   plot variation in mean annual electricity by *eff*
    -   plot variation in each year due to variation in *eff*
   

```{r sen1b, eval=T}

head(str(site2))
# this is pretty messy - but we can extract a useful data structure,lets say we want
# just the annual data (not the mean annual time series), and then reformat as a data frame with nice column names
tmp <- map_dfr(site2, `[`, c("annual"))

# convert from tibble to a data frame
site2df <- data.frame(year = tmp$annual$year, elect = tmp$annual$elect)
head(site2df)
```

## Looking at results from informal sensitivity analysis {.scrollable}

-   [Box plots or Violin Plots of Model Output (where box shows effect of parameter uncertainty)]{style="color: green;"}

WHY: To see how big the range of output might be relative to "uncertain" parameter range

-   [Plot Response against parameter value]{style="color: green;"}

WHY: To see how the parameter influences the results

-   [Average across parameter uncertainty]{style="color: green;"}

WHY: If you want the one number that is the "best guess" given uncertainty

## Variation in annual electricity due to parameter uncertainty {.scrollable}

-   boxplot
-   just need all the annual electricity by year

```{r sen2, eval=T, echo=TRUE}


# now we could plot
ggplot(site2df, aes(year, elect, group = year)) +
  geom_boxplot() +
  labs(y = "Electricity generated in kWhr")
```

## Add an average or median line

**Why?**

- Summarizes parameter uncertainty  
- Highlights interannual trends  
- Easier comparison across years

## Plot {.scrollable}

```{r sen2b,  eval=TRUE, echo=TRUE}
# we also might want an average across parameter uncertainty
site2_average <- site2df %>%
  group_by(year) %>%
  dplyr::summarize(elect = mean(elect))

# now add this to the plot - note that we remove the grouping by using group=1
ggplot(site2df, aes(year, elect, group = year)) +
  geom_boxplot() +
  labs(y = "Electricity in W") +
  geom_line(data = site2_average, aes(year, elect, group = 1), col = "orange", lwd=2)
```

## How does efficiency impact mean annual electricity estimate {.scrollable}

-   Data structure with *eff* and mean annual electricity
-   X-Y plots

Organize the data

```{r sene, eval=T, echo=TRUE}
# we could also plot how the mean annual electricity varies with efficiency (eff from above)
site2[[1]]

tmp <- map_df(site2, `[`, c("mean"))

# how variable is electricity generation (mean over all time) with uncertainty in solar efficiency

site2_mean <- data.frame(eff = eff, elect = tmp)
```

## Plot {.scrollable}

-   how variable is the model output given parameter variation
-   how does the variation in parameter impact model output

```{r sene2, eval=T, echo=TRUE}
ggplot(site2_mean, aes(y = mean)) +
  geom_boxplot(fill="yellow") +
  labs(y = "Electricity in kWhr")

# or to see what the sensitivity looks like
ggplot(site2_mean, aes(eff, mean)) +
  geom_point(size=2, col="orange") +
  labs(y = "Electricity in kWhr", x = "Solar Efficiency")

# my best guess
mean(site2_mean$mean)
```

# Sensitivity and Uncertainty

-   **Sensitivity analysis** is a way to explore how model outputs change when inputs or parameters are varied
-   **Uncertainty analysis** is a way to quantify the uncertainty in model outputs due to uncertainty in inputs or parameters

Sensitivity is more general - and the first step in uncertainty analysis, but also useful for answering model questions - is exposure to pollutants sensitivity to changes in climate inputs

# Informal Sensitivity - Learning Goals

-   comfortable varying parameters and playing with models
-   using models for understanding (by varying parameters)
-   practice building simple models
-   practice generating data structures for model output
-   practice graphing model output to explore sensitivity

Learn to "play" with models

# Assignment 3
