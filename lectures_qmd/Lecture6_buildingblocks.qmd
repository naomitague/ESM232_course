---
title: "Lecture6 Multi-Component Models "
format:
  revealjs:
    theme: solarized
    resources: ["img/"]
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

library(purrr)

library(ggpubr)

library(here)
```

## Answer to challenge from last class {.scrollable}


```{r valuep, echo=TRUE}
source(here("R/compute_NPV.R"))
source(here("R/compute_profit_frompower_priceV.R"))
source(here("R/compute_profit_frompower.R"))

best_guess_price <- 0.3  # $/kWh
best_guess_discount <- 0.04  # 4%
price_inflation <- 0.02  # 2% per year

# use output from our solar model as input to profit
# See previous lecture4_informal_sensitivity.qmd  or informal_sensitivity.qmd
load(here("Data/annual_elect_solar.rda"))
head(solar_annual_elect)

profit_solar <- compute_profit_frompower(
  energy = solar_annual_elect$elect,
  year = solar_annual_elect$year,
  price = best_guess_price, discount = best_guess_discount
)

profit_solar_alt1 <- compute_profit_frompower_priceV(
  energy = solar_annual_elect$elect,
  year = solar_annual_elect$year,
  price = best_guess_price, price_inflation=price_inflation,discount = best_guess_discount
)

best_guess_price_vector <- runif(min = 0.2, max = 0.4, n = nrow(solar_annual_elect))
profit_solar_random <- compute_profit_frompower_priceV(
  energy = solar_annual_elect$elect,
  year = solar_annual_elect$year,
  price = best_guess_price_vector, price_inflation=price_inflation,discount = best_guess_discount
)

# aggregate to compare
  combine_profit <- rbind.data.frame(
  profit_solar %>% mutate(scenario = "constant price", price = best_guess_price),
  profit_solar_alt1 %>% mutate(scenario = "inflation"),
  profit_solar_random %>% mutate(scenario = "random price"))

```
    
## Plot
```{r solarprofit, echo=TRUE}
p1 = ggplot(combine_profit, aes(as.factor(year), netpre, fill = scenario)) +
  geom_boxplot() +
  labs(y = "Net Present Value of Power in 1945 Dollars", x = "Year", fill = "Price Scenario") +
  scale_fill_manual(values = c("blue", "orange", "green"))
p1
```

## Example of a loosely coupled model

Generating profit from power generation

Will allow us to compare profits from solar and reservoir power generation

Recall diagram of our model

```{r  out.width="75%", out.height="75%", echo=FALSE }
library(knitr)
include_graphics(here("lectures_qmd/img/power_comparison_figure.jpeg" ))
```

## Our submodels {.scrollable}

-   Power generation from solar radiation (solarpv.R)
-   Power generation from reservoir height and flow rate (power_gen.R))
-   Profit from power generation (compute_profit_frompower.R) (net present value) (compute_NPV.R)

 

## Putting it all together {.scrollable}

Full picture of power options

-   run *compute_profit_frompower* for both hydro and solar power
    -   (loosely coupled models)
-   include informal parameter uncertainty analysis

Notice that we can 're-use' our functions such as *compute_profit_frompower* for both sources of power (such as our reservoir power model) to build out our complete picture

## Why?

-   Allows us to compare scenarios, accounting for parameter uncertainty

-   Illustrates a general workflow

    -   design your model - reusing where possible
    -   accounting for parameter uncertainty
    -   graphing to analyze results

## First Power Model {.scrollable}

Lets generate some example output for our reservoir model

In "real" application we'd have flow and height measurement here we will generate by sampling (think of it as test data)

-   we have measurements that tell us heights normally distributed with mean 10m and standard deviation 0.1m

-   we have measurements that tell us flow rates uniformly distributed between 0.1 and 0.3 m3/s

-   reserovir efficiency varies uniformly from 0.4 to 0.7

## Code {.scrollable}

-   generate sample inputs for each year
    -   corresponding to years that we have power for the solar model
-   generate uncertainty in efficiency
-   run power model for those inputs and parameter uncertainty
-   compute profit from power

(do some data reorganization as we go to make it easier to graph)

```{r powerres, echo=TRUE}
# repeating what we did before
# lets start with hydro power
source(here("R/power_gen.R"))

# Step 1 - create some sample data for our reservoir model

# we are 'making up' inputs for hydro power - to have it match the number of year
# that we had solar values for, lets sets the number of runs equal to the number of years

number_years <- length(profit_solar$year)

reservoir_model_res <- as.data.frame(matrix(nrow = number_years, ncol = 3))

colnames(reservoir_model_res) <- c("height", "flow", "power")

# Step 2 - generate heights and flow rates
reservoir_model_res$height <- rnorm(mean = 15, sd = 3.5, n = number_years)

reservoir_model_res$flow <- runif(min = 0.001, max = 0.3, n = number_years)

# Step 3 - generate uncertainty due to reservoir efficiency, lets assume that
# we know its somewhere between 0.4 and 0.7
Keff <- runif(min = 0.5, max = 0.7, n = 20)

# Step 3 - apply model to get power for each height, flow rate (each year), across
# uncertainty in efficiency
reservoir <- Keff %>% map_dfc(~ power_gen(
  height = reservoir_model_res$height,
  flow = reservoir_model_res$flow, Keff = .x
))

colnames(reservoir) <- Keff

head(reservoir)


# add years - remember we are making up data for the same years that we have solar
reservoir$year <- profit_solar$year

# reorganize for easier analysis
reservoirg <- as.data.frame(reservoir) %>% pivot_longer(!year, names_to = "Keff", values_to = "power")
head(reservoirg)
```

# Now compute profit ( like we did for solar)....

```{r powerprofit, echo=TRUE}

source(here("R/compute_NPV.R"))
source(here("R/compute_profit_frompower.R"))

best_guess_price <- 0.3  # $/kWh
best_guess_discount <- 0.04  # 4%

# create profit from hydro
profit_hydro <- compute_profit_frompower(energy = reservoirg$power, year = reservoirg$year, price = best_guess_price, discount =best_guess_discount)
compute_NPV

names(profit_hydro)
```

## Plot

```{r powerresp, echo=TRUE}
# plot
ggplot(profit_hydro, aes(as.factor(year), netpre, group = year)) +
  geom_boxplot() +
  labs(y = "Net Present Value of Power in 1945 Dollars", x = "Year")


```

## Compare Profit from hydro/reservoir with solar {.scrollable}

```{r quicksum}

mean(profit_hydro$netpre)
mean(profit_solar$netpre)

```

Hydro wins? Right?

## Comparison taking into account uncertainty. {.scrollable}

```{r power2, echo=TRUE}

a <- ggplot(profit_hydro, aes(year, netpre, group = year)) +
  geom_boxplot() +
  labs(title = "Hydro", y = "Net Present Values in 1945 Dollars", x = "Year")
b <- ggplot(profit_solar, aes(year, netpre, group = year)) +
  geom_boxplot() +
  labs(title = "Solar", y = "Net Present Values in 1945 Dollars", x = "Year")
ggarrange(a, b)
```

## Better comparison - same graph

```{r powergraph, echo=TRUE}
# put on one graph
# combine to get a nice legend
profit_hydro$etype <- "Hydro"
profit_solar$etype <- "Solar"
tmp <- rbind.data.frame(profit_hydro, profit_solar)
ggplot(tmp, aes(as.factor(year), netpre, fill = etype)) +
  geom_boxplot() +
  labs(y = "Net Present Values in 1945 Dollars", x = "Year", fill = "Power Type") +
  scale_fill_manual(values = c("blue", "orange"))
```

## How might we quantify uncertainty

-   look at spread of net present values

```{r quicksd}

sd(profit_hydro$netpre)
sd(profit_solar$netpre)

```



## What we discovered

While hydro profits are higher - they are more uncertain

What would you chose?

What would a manager chose?

Note - we considered uncertainty in just a few parameters Would accounting for uncertainty in price change our analysis? How?

If we wanted to reduce uncertainty in hydro profits - what measurements would we make? (or what parameter might we focus on?) How would we figure that out? (something to think about)


## Workflow ideas


 * start with submodel sensitivity analysis 
  * hydro - *eff, height, flow rate*
  * solar - *eff, ethresh, solar, PR, area*
 * build multi component model
  * additional sensitivity analysis (price, discount rate)
  
  Could build a wrapper to do this
  
  Models will often have a data structure (or file) that parameter values to explore
  * could build a function to read this in and run the model for each parameter set
  
  
# Summary {.scrollable}

-   we built a multi component model to compare profit from two different power sources

-   we re-used functions to build out our model

-   we included parameter uncertainty analysis to see how that impacted our profit estimates

-   we saw how data organization is an important part of informal sensitivity analysis to make it easier to graph and analyze results


## What you can know about sensitivity before experimenting {.scrollable}

-   when transfer function is linear (equation *tells* you what the sensitivity is)

-   Imagine that habitat suitability for parrot can be modelled with the following equations, where

$$
 PS = k_P * P + k_T * T
$$

-   **PS** probability that parrots will be found in a given location

-   **P** is mean annual precipitation

-   **T** is mean annual temperature

-   $k_P$ and $k_T$ are empirically derived coefficients

<span style="color: blue;"> Sensitivity to $k_P$ and $k_T$ will be linear

if $k_P$ is 0.002 and $k_T$ is 0.01 does that mean parrot suitability is more sensitive to temperature than precipitation?

*Yes or No?*

# Sensitivity of the output

Coefficient values - depends on what range in **T** and **P** so its hard to tell just from the coefficients

<span style="color: blue;"> *IF* </span> **P** and **T** were in the same units (e.g percent deviation from a mean value), then you could use the coefficients to tell you if parrot suitability would be more sensitive to a 10% change in precipitation versus a 10% change in temperature

$$
 PS = k_P * (P-Pavg)/Pavg + k_T * (T-Tavg)/Tavg
$$

## Statistics

Regression equations are also models

They are *linear* models

The coefficients and standard error tell you about sensitivity

- larger coefficients = output more sensitive to variation in the "variable"

- smaller standard error = more confidence in coefficient

## When do we need to do sensitivity analysis {.scrollable}

-   Looking at the form of the equations in the box (transfer function) often tells you something about sensitivity

-   The first derivative of the equation with respect to the parameter IS the sensitivity; so if you can take the derivative you can *know* something about the sensitivity

-   BUT if you don't know what's in the box (transfer function) or if it has multiple boxes its difficult to tell

-   any equation/transfer function with thresholds (if's, max, min's) hard to tell (you can't differentiate), sometimes parameters may matter sometimes they will not


What do we do then...explore...and

# Assignment 4 {.scrollable}
