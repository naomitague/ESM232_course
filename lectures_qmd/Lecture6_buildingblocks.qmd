---
title: "Lecture6_Multi-Component Models "
format:
  revealjs:
    theme: solarized
    resources: ["img/"]
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

library(purrr)

library(ggpubr)

library(here)
```

# Building models with blocks


## Example of a loosely coupled model

Generating profit from power generation

Will allow us to compare profits from solar and reservoir power generation

Recall diagram of our model

```{r  out.width="75%", out.height="75%", echo=FALSE }
library(knitr)
include_graphics(here("lectures_qmd/img/power_comparison_figure.jpeg" ))
```

## Our submodels {.scrollable}

* Power generation from solar radiation (solarpv.R)
* Power generation from reservoir height and flow rate (power_gen.R))
* Profit from power generation (compute_profit_frompower.R)
  (net present value)   (compute_NPV.R)
  
Whats nice about boxes
  * can re-use them
  * can swap them out
  * different team members can work on different boxes

## Putting it all together {.scrollable}

Full picture of power options

-   run *compute_profit_frompower* for both hydro and solar power

-   include informal parameter uncertainty analysis

Notice that we can 're-use' our functions such as *compute_profit_frompower* for both sources of power (such as our reservoir power model) to build out our complete picture

## Why?

-   Allows us to compare scenarios, accounting for parameter uncertainty

-   Illustrates a general workflow

    -   design your model - reusing where possible
    -   accounting for parameter uncertainty
    -   graphing to analyze results

## First Power Model {.scrollable}

Lets generate some example output for our reservoir model

In "real" application we'd have flow and height measurement here we will generate by sampling (think of it as test data)

## Code {.scrollable}

-   generate sample inputs for each year
    -   corresponding to years that we have power for the solar model
-   generate uncertainty in efficiency
-   run power model for those inputs and parameter uncertainty
-   compute profit from power

(do some data reorganization as we go to make it easier to graph)

```{r powerres, echo=TRUE}
# repeating what we did before
# lets start with hydro power
source(here("R/power_gen.R"))

# Step 1 - create some sample data for our reservoir model

# we are 'making up' inputs for hydro power - to have it match the number of year
# that we had solar values for, lets sets the number of runs equal to the number of years

number_years <- length(profit_solar$year)

reservoir_model_res <- as.data.frame(matrix(nrow = number_years, ncol = 3))

colnames(reservoir_model_res) <- c("height", "flow", "power")

# Step 2 - generate heights and flow rates
reservoir_model_res$height <- rnorm(mean = 10, sd = 1, n = number_years)

reservoir_model_res$flow <- runif(min = 0.1, max = 1, n = number_years)

# Step 3 - generate uncertainty due to reservoir efficiency, lets assume that
# we know its somewhere between 0.4 and 0.7
Keff <- runif(min = 0.4, max = 0.7, n = 20)

# Step 3 - apply model to get power for each height, flow rate (each year), across
# uncertainty in efficiency
reservoir <- Keff %>% map_dfc(~ power_gen(
  height = reservoir_model_res$height,
  flow = reservoir_model_res$flow, Keff = .x
))

colnames(reservoir) <- Keff

head(reservoir)


# add years - remember we are making up data for the same years that we have solar
reservoir$year <- profit_solar$year

# reorganize for easier analysis
reservoirg <- as.data.frame(reservoir) %>% pivot_longer(!year, names_to = "Keff", values_to = "power")
head(reservoirg)

# create profit from hydro
profit_hydro <- compute_profit_frompower(energy = reservoirg$power, year = reservoirg$year, price = 30, discount = 0.04)

names(profit_hydro)
```

## Plot

```{r powerresp, echo=TRUE}
# plot
ggplot(profit_hydro, aes(as.factor(year), netpre, group = year)) +
  geom_boxplot() +
  labs(y = "Net Present Value of Power in 1945 Dollars", x = "Year")
```

## Compare Profit from hydro/reservoir with solar {.scrollable}

we now have profit_hydro and profit_solar

```{r power2, echo=TRUE}

a <- ggplot(profit_hydro, aes(year, netpre, group = year)) +
  geom_boxplot() +
  labs(title = "Hydro", y = "Net Present Values in 1945 Dollars", x = "Year")
b <- ggplot(profit_solar, aes(year, netpre, group = year)) +
  geom_boxplot() +
  labs(title = "Solar", y = "Net Present Values in 1945 Dollars", x = "Year")
ggarrange(a, b)

# put on one graph
ggplot(profit_hydro, aes(year, netpre, group = year)) +
  geom_boxplot() +
  labs(y = "Net Present Values in 1945 Dollars", x = "Year", title = "Both") +
  geom_boxplot(data = profit_solar, aes(year, netpre, group = year), fill = "orange")

# or do get a nice legend
profit_hydro$etype <- "Hydro"
profit_solar$etype <- "Solar"
tmp <- rbind.data.frame(profit_hydro, profit_solar)
ggplot(tmp, aes(as.factor(year), netpre, fill = etype)) +
  geom_boxplot() +
  labs(y = "Net Present Values in 1945 Dollars", x = "Year", fill = "Power Type") +
  scale_fill_manual(values = c("blue", "orange"))
```

# Summary {.scrollable}

-   we built a multi component model to compare profit from two different power sources

-   we re-used functions to build out our model

-   we included parameter uncertainty analysis to see how that impacted our profit estimates

## What you can know about sensitivity before informal/formal sensitivity analysis {.scrollable}

-   Parameter interactions are *evident* in the equations

Recall our reservoir model

-   **Input**: Reservoir height and flow rate

-   **Output**: Instantaneous power generation (W/s)

-   **Parameters**: K (efficiency) , ρ (density of water), g (acceleration due to gravity)

P = ρ \* h \* r \* g \* K

-   P is Power in watts,
-   ρ is the density of water (\~1000 kg/m3)
-   h is height in meters,
-   r is flow rate in cubic meters per second,
-   g is acceleration due to gravity of 9.8 m/s2,
-   K Efficiency is a coefficient of efficiency ranging from 0 to 1.

<span style="color: blue;"> The "effect" of **K** (efficiency) will depend on the other parameters

A 1% change in **K** will lead to a 1% change in Power

<span style="color: blue;"> How much Power (magnitude) will change with an increase **K** will depend on value of other parameters and inputs

So you could say that Power is more sensitive to efficiency for larger flow rates or larger heights, We know this because the are multiplied together!

## Some code to convince you of this {.scrollable}

```{r simplex}
# lets look at the power generation function
source(here("R/power_gen.R"))
Power_K1 <- power_gen(height = 2, flow = 4, K = 0.1, g = 9.8)
Power_K1
Power_K2 <- power_gen(height = 2, flow = 4, K = 0.2, g = 9.8)
Power_K2

# if you double K, you will double power (linear response)
# relative change in power
0.1 * 2

Power_K1 * 2

Power_K2 / Power_K1
```

##  {.scrollable}

*Because* the equation is just multiplying factors

-   Relative change is the same as the change in efficiency (K)
-   Absolute change in power with change in efficiency depends on other parameters

So what happens to sensitivity if height is 3 instead of 2

```{r simplex2}
# absolute change in power depends on other parameters/inputs
# absolute change in pawer or magnitude of the change in power with change in efficiency (difference)
Power_K2 - Power_K1

# if height is 3 instead of 2
Power_K1 <- power_gen(height = 3, flow = 4, K = 0.1, g = 9.8)
Power_K1
Power_K2 <- power_gen(height = 3, flow = 4, K = 0.2, g = 9.8)
Power_K2

# Power still doubles (relative change is the same)
Power_K1 * 2

# But absolute change is greater
Power_K2 - Power_K1
```

##  {.scrollable}

# Assignment 4 {.scrollable}
