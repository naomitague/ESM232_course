---
title: "Sensitivity with ODEs"
format: revealjs
theme: solarized
resources: ["img/"]
css: ["slides.css"]
editor: visual
---

```{r setup, include=FALSE}
library(tidyverse)
library(deSolve)
library(here)
library(sensitivity)
```

## Sensitivity Analysis of a Differential Equation {.scrollable}

We can apply sensitivity analysis to a differential equation

A key issue where is sensitivity of what?

Dynamic models often give you many many outputs

-   time series (streamflow every day for a year, population for 30 years)
-   or output over space (spatially averaged concentration after 10 days?)

So if we are asking 'sensitivity of what' we need to summarize results in some way (reduce their dimensionality )

## Some options for reducing output dimensionality (summarizing output) {.scrollable}

Depends on what is important for your model application

-   max
-   mean
-   min
-   total
-   variation
-   time it takes for something to happen

So a key step in sensitivity analysis with a dynamics model is summarizing results into a few key measures

Its useful to turn that summarizing workflow into a function

## Workflow for Sensitivity Analysis {.scrollable}

1)  implement (or identify pre-existing) dynamic model

2)  obtain samples of parameter sets (from sobel or LHS)

3)  build a function that will extract the information (metrics) you want from your dynamic model (output of the ode)

4)  create a data structure to store the metrics for each parameter set - in my example I call it metrics (but could be anything)

5)  decide on initial conditions and time period over which you will run the model

6)  run ODE for each parameter sets to fill in this metrics data structure

    -   its usually helpful to create a wrapper function
        -   runs ODE
        -   extracts metrics
    -   run wrapper function for each parameter sets

7)  send the metrics back to the sensitivity analysis object (from sobel or LHS)

8)  plot and analyze results

## Example ODE sensitivity with a population model {.scrollable}

This one includes a carrying capacity

Step 1 and 2 with population model

Always a good practice to "try" you model on one parameter set *before* trying to run for all parameters

```{r sen}
source(here("R/dpopgrowth.R"))

dpopgrowth

# lets start with sobel
library(sensitivity)

# come up with first set of sample parameters
# we will assume that we know the initial population,

Pinitial <- 10

# want to learn about sensitivity to growth rate (r) and carrying capacity
# set the number of parameter samples you have as 2000
np <- 2000
# Assume parameters are normally distributed
# sample K with mean of 200, standard devidation of  50
# sample r with mean of 0.02 and standard deviation of 0.005

# repeat to get our second set of samples

# fix any negative values and they are not meaningful (using pmax and map_df)


# create our sobel object and get sets ofparameters for running the model, use sobolSalt



# take a look at parameter sets


# lets add names

```

## Running the ODE and summarizing output {.scrollable}

Step 3-6 in workflow

Run our differential equation for all parameters and keep

-   the output - volume of output quickly becomes a problem

Just save metrics

A couple of options

-   how about maximum population if we run the model for 200 years,
-   how many years to get to the carrying capacity
-   how many year to get to some pre-determined threshold

## Streamlining workflow with functions

Create two additional functions that will help us

-   a function that computes the metrics we want

-   a function that runs our ode solver and computes the metrics (I call it a **wrapper** function as it is really just a workflow/wrapper to call ode solver and then compute metrics)

-   wrapper takes as input

    -   parameters
    -   initial conditions
    -   simulation time
    -   ode (function name)
    -   how to compute metrics (function name)

-   always test to make sure it works (good coding practice)

```{r sen2}
# turn computing our metrics into a function, have thresh be an input

compute_pop_metrics <- function(result, thresh) {
  # first add maximum population
  
  # find when populatin is greater than the threshold

  # account for sitation with threshold is never reached

  # return results (maxpop and threshyear) as a list
 
}

# Test that it works
# try it on our first parameter set, and look at when it gets to 100
# initial population

# run for 500 days, save as a variable for later resue

# use the first parameter set (or you could just pick a test value), not the list because ode wants parameters as a list, so name each

# run ode

# turn ode results into a labelled data frame 

# run metrics on results, lets use a threshold of 100


# great but we need to apply the ode and this function for all of our parameters

# define a wrapper function to do everything we need - run solver and compute metrics - and send back results for each parameter

# lets make the threshold 90% of carrying capacity

p_wrapper <- function(r, K, Pinitial, simtimes, odefunc, metricfunc, metricpars) {
  
  # create parameter list

  # run ode
  
  # results as a data frame
 
  # get metrics
  
  # compute metrics
  
  return(metrics)
}

# test with specific r and K values (r=0.01, K=150) and Pinitial=3 # just do 10 time steps


# try with first row of our Sobol parameters
# Pinitial=10, use our simtimes

```

## Next step {.scrollable}

Run the wrapper for all parameters and look at results

```{r userwarpper, error=TRUE}
# now use pmap as we did before, but run the wrapper function


# extract out results from pmap into a data frame

# do a quick summary to get a sense of the range

# create boxplots of our two metrics for all parameters - use facet wrap since population and year are different y-axis

```

## Compute the sobol indicies for each metric {.scrollable}

-   save the *tell* to different objects so you can keep re-using the original sobol object

-   look at total effect and first order sensitivity

-   Step 7 in workflow

```{r sen3}
# sobol can only handle one output at a time  - so we will need to do them separately


# lets start with threshyear
# "tell" the sensitivity analysis object - re-name so we keep separate

# first-order indices (main effect without co-variance)

# total sensitivity index -note that this partitions the output variance - so values sum to 1


# graph metric against most parameter that the output is most sensitive to, using #2 for color
# create a data frame

```

## Repeat for Maximum Population Reached {.scrollable}

remember to create a different sens_P object

```{r senpop}

# create another one for max population
sens_P_maxpop <- sensitivity::tell(sens_P, allres$maxpop)

# first-order indices (main effect without co-variance)
rownames(sens_P_maxpop$S) <- c("r", "K")
sens_P_maxpop$S

# total sensitivity index -note that this partitions the output variance
rownames(sens_P_maxpop$T) <- c("r", "K")
sens_P_maxpop$T

# graph metric against most parameter that the output is most sensitive to, using #2 for color
# create a data frame
allresp = as.data.frame(cbind(sens_P$X, allres))
ggplot(allresp, aes(K, maxpop, col=r ))+geom_point()+
  labs(y="Year that threshold is reached", x="K")
```

## Negative sobol first order indices {.scrollable}

if confidence interval includes zero - not a problem

if it doesn't there are numerical issues - try running more samples

## Error messages from Sobol {.scrollable}

*All values of t are equal to 0.999999999999856* \n Cannot calculate confidence intervals

relationship looks like its completely prescribed - which is true in the case of carrying capacity

## Error messages from ODE {.scrollable}

*In lsoda(y, times, func, parms, ...) : an excessive amount of work (\> maxsteps ) was done, but integration was not successful - increase maxsteps*

Suggest that the solver (numerical integration) had issues

-   increasing maxsteps can help

    ```         
    *result = ode(y=Pinitial, times=simtimes, func=func, parms=parms, maxsteps=100000) *
    ```

-   trying different methods

    ```         
    *result = ode(y=Pinitial, times=simtimes, func=func, parms=parms, method="daspk")*
    ```

-   "stiff" problems are harder for numerical integration to solve - (small changes have big impacts); a threshold carrying capacity does that \## Ways to use dynamic models {.scrollable}

Goal: To provide insight into environmental systems, and how they respond to intervention/disturbance/change

-   predict how something we care above will change over space and/or time (*system evolution*)

-   sensitivity analysis of output

    -   output response to variation in inputs/parameters
    -   quantifying how summary measures respond to variation in inputs/parameters

## Disturbance {.scrollable}

-   Sometimes we are interested in how dynamics of a system (through time or space) are influenced by a force of change

    -   Press - continuous through time; slowly increasing or decreasing
    -   Pulse - intervals/one-time - could be a shock to the system

Examples?

## Modelling disturbance {.scrollable}

Disturbance is [**exogenous**]{style="color:orange"}, (modelled outside of the model and then input)

Disturbance is integrated into the model [**endogenous**]{style="color:orange"}

## Questions to ask {.scrollable}

[Exogenous or Endogenous implementation]{style="color:orange"}

-   do you care about feedbacks between the system state and disturbance frequency or severity
    -   fire is a disturbance that influences vegetation; but vegetation influences likelihood of future fire (YES)
    -   high intensity precipitation (flood events) might be a disturbance; but streamflow response probably doesn't impact likelihood of future high intensity precipitation (NO)
-   do you have a model of the disturbance
    -   could you integrate this model into your existing dynamic model

=======

-   sensitivity analysis of output (*output generated by solving differential equation to see system evolution in time or space*)

    -   output response to variation in inputs/parameters
    -   quantifying how summary measures respond to variation in inputs/parameters

## Disturbance {.scrollable}

-   Sometimes we are interested in how dynamics of a system (through time or space) are influenced by a force of change

    -   Press - continuous through time; slowly increasing or decreasing
    -   Pulse - intervals/one-time - could be a shock to the system

Examples?

## [Assignment]{style="color:orange"} {.scrollable}

Assignment6 - Using Sobol with an ODE
