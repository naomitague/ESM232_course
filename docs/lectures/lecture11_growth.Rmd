---
title: "Modeling Growth and Disturbance with Dynamic Models"
output:
  slidy_presentation:
    highlight: pygments
  html_document: default
  pdf_document: default
  ioslides_presentation:
    highlight: pygments
  beamer_presentation:
    highlight: pygments
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sensitivity)
library(tidyverse)
library(deSolve)
```

# Ways to use dynamic models 

Goal: To provide insight into environmental systems, and how they respond to intervention/disturbance/change

* predict how something we care above will change over space and/or time (*system evolution*)

* sensitivity analysis of output (*output generated by solving differential equation to see system evolution in time or space*)

  * output response to variation in inputs/parameters
  * quantifying how summary measures respond to variation in inputs/parameters



# Disturbance

* Sometimes we are interested in how dynamics of a system (through time or space) are influenced by
a force of change

  * Press - continuous through time; slowly increasing or decreasing
  * Pulse - intervals/one-time - could be a shock to the system
  
Examples? 

How would we model these?

# Modelling disturbance

Disturbance is <span style="color:orange">**exogenous**</span>, (outside of the model)

Disturbance is integrated into the model  <span style="color:orange">*endogenous**</span>

# Questions to ask

<span style="color:orange">Exogenous or Endogenous implementation </span>

* do you care about feedbacks between the system state and disturbance frequency or severity
    * fire is a disturbance that influences vegetation; but vegetation influences likelihood of future fire (YES)
    * high intensity precipitation (flood events) might be a disturbance; but streamflow response probably doesn't impact likelihood of future high intensity precipitation (NO)
    
* do you have a model of the disturbance 
    * could you integrate this model into your existing dynamic model

Exogenous is easier to implement; and may allow you to use output from another model
even if there are feedbacks it might still be useful to see what happens after a disturbance

Endogenous allows for a more complete integration of the disturbance

# Modelling disturbance - an example


What would our model look like if we harvest the forest on a regular basis

Some possible  options

1. Disturbance is **exogenous** (outside of the model)

    * look at post-harvest recovery

2. Disturbance is integrated into the model **endogenous**

    * a fixed harvest every year

    * proportional harvest (% of current stock)


We can build this on a forest growth model

# Lets consider forest growth

Modeling carbon growth in a forest

* r is growth rate
* K is maximum carbon capacity of the forest

We can actually re-use our model - if we assume forest growth follows a logistic growth curve
(e.g exponential growth towards a carrying capacity)

Let's consider harvesting as **exogenous** first - simply change the starting condition

# Exogeneous model

```{r forest}
source("../R/dexppopK.R")

dexppopK
# set parameters
forestparms = list(K=100,r=0.2)

# create a time sequence
tm = seq(from=1,to=100)

# start a small forest
postfire_initial_carbon = 2

# watch it grow
forest = ode(y=postfire_initial_carbon, times=tm, dexppopK, parms=forestparms)

colnames(forest)=c("time","carbon")
ggplot(as.data.frame(forest),aes(time, carbon) )+geom_line()


```

# Regular Harvest

Lets consider a regular harvesting of the forest

Lets start with an annual proportional harvest

We can include harvesting in our forest  (and a new parameter **harv** (proportional harvesting rate))



```{r harvest}

# fixed amount per year
source("../R/dharvest.R")
dharvest

# try it out
tm = seq(from=1, to=500)
Cinitial = 1
gps = list(harv=0.18, K=100, r=0.2)
res = ode(Cinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()


```

# How does harvesting rate effect carbon 

Compute trajectories of forest biomass (or carbon) over time - given different harvesting rates

```{r harvest2}

# what if we harvest a a much greater rates
# lets vary the harvest rates from 0.0 to 0.4
harvestr = seq(from=0.0, to=0.4, by=0.025)

# save all of the trajectories
# use a wrapper function to just return the carbon trajectories
getcarbon = function(Cinitial, tm, harv, K, r, hfunc) {
  gps = list(harv=harv, K=K, r=r)
  res = ode(Cinitial,tm, hfunc, gps)
  colnames(res)=c("time","carbon")
  res=as.data.frame(res)
  return(carbon=res$carbon)
}

# apply this function to all harvest values
res = harvestr %>% map_dfc(~getcarbon( Cinitial=Cinitial, tm=tm, K=100, r=0.2, hfun=dharvest, harv=.x))
# rows are time, columns are carbon for each harvest scenario
colnames(res)=harvestr
res=as.data.frame(res)
res$time=tm
# put in to a form where we can plot
resl = gather(res, key="harvestr",value="carbon", -time)
ggplot(resl,aes(time, carbon, col=harvestr))+geom_line()


# notice that stable forest value changes with harvest rates

# notes that some forests are not stable - (or forest size goes to zero)

# see this at the beginning - plot the first 10 years
ggplot(subset(resl, time < 10),aes(time, carbon, col=harvestr))+geom_line()

```
# Interactions

How do different harvest rates interact with different growth rates (and/or) carrying capacity?

Common "type" of question - how does disturbance interact with the properties (parameters) of the system?

Explore on your own

Try different combination of growth and 
harvest rates...

notice how carbon growth changes...what does stability mean - can you find parameter sets that lead to a stable non-zero forest

# Sensitivity Analysis

We could do some sensitivity analysis to see how harvest rate, and growth rate interact

Sensitivity of what? What do we care about?

  * forest ends up after 10 years and 50 years (short and long planning horizons)

We will use our compute metrics and wrapper to make this easy

```{r harvestsend}

# fixed amount per year
source("../R/dharvest.R")


# lets assume a uniform distribution of harvest rates
# and of normal growth rates
np=200

r = rnorm(mean=0.3, sd=0.05, n=np)
harv = runif(min=0.0, max=0.4, n=np)
K = 
X1 = cbind.data.frame(r=r, harv=harv)

# repeat to get our second set of samples
r = rnorm(mean=0.3, sd=0.05, n=np)
harv = runif(min=0.0, max=0.4, n=np)
X2 = cbind.data.frame(r=r, harv=harv)

# create our sobel object and get sets of parameters for running the model

sens_forest = sobolSalt(model = NULL,X1, X2, nboot = 300)
colnames(sens_forest$X)= c("r","harv")
# do a quick test
# try it out
tm = seq(from=1, to=50)
Cinitial = 1
parms = list(r=sens_forest$X[1,1], harv=sens_forest$X[1,2], K=100)
res = ode(y=Cinitial,times=tm, func=dharvest, parms=parms)
res=as.data.frame(res)
colnames(res)=c("time","C")

# compute our two metrics of interest - harvest after 10 and 50 years
compute_metrics = function(res) {
 C50 = res[50]
 C10 = res[10]
return(list(C50=C50, C10=C10))}

# use a wrapper function to just return the carbon trajectories
p_wrapper = function(r,harv, K, Cinitial, simtimes, func) {
    parms = list(r=r, K=K, harv=harv)
    result = ode(y=Cinitial, times=simtimes, func=func, parms=parms) 
    result=as.data.frame(result)
   colnames(result)=c("time","C")
  # get metrics
  metrics=compute_metrics(result$C)
  return(metrics)
}

# notice how we added in K, a parameter that we are NOT varying

# try it out
tm = seq(from=1, to=50)
Cinitial = 1


allresults = as.data.frame(sens_forest$X) %>% pmap(p_wrapper, K=100, Cinitial=Cinitial, simtimes=tm, func=dharvest)

# extract out results from pmap into a data frame
allres = allresults %>% map_dfr(`[`,c("C10","C50"))

tmp = allres %>% gather(key="metric", value="value")
ggplot(tmp, aes(metric, value, col=metric))+geom_boxplot()

# link with parameters to see how parameters together
# impact something we care about C50

allresp = cbind.data.frame(sens_forest$X, allres)
ggplot(allresp, aes(harv, C50, col=r))+geom_point()

# notice how we can see the impact of harvesting - and how growth rates reduce the sustainable harvest


# sobol indices
sens_forest_C50 = sensitivity::tell(sens_forest, allres$C50)
rownames(sens_forest_C50$T)=c("r","harv")
sens_forest_C50$T
rownames(sens_forest_C50$S)=c("r","harv")
sens_forest_C50$S

```

# Fixed Harvest

What if you wanted to take the same amount of carbon each year - what would the model look like?

# Fixed Example

```{r fixed}

source("../R/dharvestfixed.R")

dharvestfixed

# try it out with different initial conditions to watch how the system moves to a stable state
tm = seq(from=1, to=500)
Cinitial = 500
gps = list(harv=10, K=1000, r=0.05, mincarbon=0)

res = ode(Cinitial,tm, dharvestfixed, gps)
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 500kgC")
```



# Extra Credit Assignment


1. Add a harvesting to your forest growth model from the previous assignment
You can be as simple or complex as you want (e.g you could repeat what I did above by making harvesting proportional to biomass)

2. Perform some sensitivity analysis to assess how harvesting parameters interact with forest growth parameters to influence
forest carbon at the end of the simulation time period (you can choose how long this is)

3. Write 2-3 sentences to comment on what you might learn from your sensitivity analysis

