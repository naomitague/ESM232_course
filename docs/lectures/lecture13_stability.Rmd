---
title: "Exploring Stability in Dynamic Systems"
output:
  slidy_presentation:
    highlight: pygments
  html_document: default
  pdf_document: default
  ioslides_presentation:
    highlight: pygments
  beamer_presentation:
    highlight: pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sensitivity)
library(tidyverse)
library(deSolve)
```
# Ways to use dynamic models 

Goal: To provide insight into environmental systems, and how they respond to intervention/disturbance/change

* sensitivity analysis of output (output generated by solving differential equation to see system evolution in time or space)
  * output response to variation in inputs/parameters
  * quantifying how summary measures respond to variation in inputs/parameters
  
  * *examine derivative at different values (simpler, not solving required but just tells you how system will change given a particular state)*
  * *how does stability vary with inputs/parameters*



# Stability


Stability analysis investigates how system state changes, particularly focusing on whether the system state 'ends up' and what happens when there are small perturbations to the system state

Example?

# Stability analysis for simple differential equations

We can look at how the derivative (rate of change) under different system states to get a picture of when our system will be stable (e.g where small perturbations just bring the system back to a relatively constant state)


One way we can do this WITHOUT solving the differential equation is to look at the derivatives at different values

* When the derivative is 0 the system is stable

* Positive derivatives are growth

* Negative are decline

We can use derivatives to see whether and when stability will happen

# Harvest as an example

```{r stability2}

source("../R/dharvest.R")
dharvest

# given some forest characteristics - lets look at derivatives under different harvest rates
lowHrate = 0.015
gps = list(harv=lowHrate, K=100, r=0.05)

# look at the derivative over a range of forest sizes

findstable = data.frame(Ccurr=seq(from=1, to=100, by=5))
# notice use of Time=NULL, and map to compute derivative
# for different values of forest biomass
findstable$dervHlow= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, P=.x) ))
                                                  
ggplot(findstable, aes(Ccurr, dervHlow))+geom_point()+geom_hline(yintercept = 0, col="red")+
  labs(y="Derivative\n (Rate of change of forest carbon) (kg/C/year)", x="Current Forest Carbon Stock (kgC)")

# Populations will be stable when derivative is zero!

# look at a different harvest rate
midHrate=0.02
gps = list(harv=midHrate, K=100, r=0.05)
findstable$dervHmid= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, P=.x) ))
 
# try high rate
highHrate=0.05
gps = list(harv=highHrate, K=100, r=0.05)
findstable$dervHhigh= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, P=.x) ))
 

# plot them all together
tmp = gather(findstable, key="HarvestRate", value="value", -Ccurr)
ggplot(tmp, aes(Ccurr, value, color=HarvestRate))+geom_point()+geom_hline(yintercept = 0, col="black")+
  labs(x="Forest Biomass (kgC)", y="Forest Growth Rate (kgC/year)")

# notice how with higher harvest rates the stable population will be lower




```

# Stability in changing systems - just looking at dervatives

Knowing the stability can help you understand the dynamics of the system

If we start with a Forest Carbon of 50 and low harvest rate what will happen

If we start with a Forest Carbon of 50 and a high harvest rate what will happen

Try it to find out if you are right
```{r  check}

tm = seq(from=1, to=500)
gps = list(harv=lowHrate, K=100, r=0.05)
Pinitial=50
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")
ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
  labs(y="Forest Biomass (kgC)", x="Year", title="low harvest rate")
  



gps = list(harv=highHrate, K=100, r=0.05)
Pinitial=50
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")
ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
 labs(y="Forest Biomass (kgC)", x="Year", title="High Harvest Rate")




```

# In class challenge

We can more formally find stablity by finding the system state when the derivative is zero


What if we have a slightly different forest management task -  to make harvest a fixed amount of  carbon but only take it if it is above a threshold minimum carbon

Think about how you would explore stability here

* create a new derivative function based on *dharvest.R*, but modify so that harvest is now a fixed value rather that a proportion of forest carbon

* assume a forest growth rate of 0.05, a carrying capacity of 1000kg and a harvest rate of 10kg/year

* can you figure out what the two stable values of forest carbon will be without running the ODE

# here's what I did

```{r stability}

source("../R/dharvestfixed.R")

# first lets look at how the derivative varies with the size of forest

carbon = seq(from=0, to=1000)
dcarbon= unlist(carbon %>% map(dharvestfixed,Time=NULL, parms=list(r=0.05, K=1000, mincarbon=0, harv=10)))

ggplot(as.data.frame(carbon,dcarbon), aes(carbon, dcarbon))+geom_point()+geom_hline(yintercept = 0, col="red")+
  labs(y="Derivative\n (Rate of change of forest carbon) (kg/C/year)", x="Current Forest Carbon Stock (kgC)")

# try it out with different initial conditions to watch how the system moves to a stable state
tm = seq(from=1, to=500)
Pinitial = 500
gps = list(harv=10, K=1000, r=0.05, mincarbon=0)

res = ode(Pinitial,tm, dharvestfixed, gps)
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 500kgC")


#  try smaller starting condition
tm = seq(from=1, to=500)
Pinitial = 1
gps = list(harv=10, K=1000, r=0.05, mincarbon=0)

res = ode(Pinitial,tm, dharvestfixed, gps)
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 1kgC")


#  try smaller starting condition
tm = seq(from=1, to=500)
Pinitial = 15
gps = list(harv=10, K=1000, r=0.05, mincarbon=0)

res = ode(Pinitial,tm, dharvestfixed, gps )
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 1kgC")

# try a different method
res = ode(Pinitial,tm, dharvestfixed, gps, method="euler" )
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 1kgC")


```

